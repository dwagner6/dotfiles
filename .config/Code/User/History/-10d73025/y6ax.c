#include "i2c0.h"
#include "uclib.h"
#include <rp2040/i2c.h>
#include <stdint.h>
#include <stdbool.h>

#define I2C_ADDR           0x74
#define REF_LSB_REG        0x00
#define REF_MSB_REG        0x01 
#define REF_MSB_REG_MASK   0x03    // only lowest 3 bits of REF_MSB are used
#define IOUT_LIMIT_REG     0x02 
#define VOUT_FS_REG        0x04
#define VOUT_FS_REG_MASK   0x83    // only bits 7, 1, 0 used
#define MODE_REG           0x06
#define STATUS_REG         0x07
#define OE_BIT             7
#define HICCUP_BIT         5    // default on reset
#define DSCHG_BIT          4

static const uint16_t voltage_lookup[171] = {
    0x00dcU, 0x00e6U, 0x00f0U, 0x00faU, 0x0104U, 0x010eU, 0x0118U, 0x0122U, 0x012cU, 0x0136U,
    0x0140U, 0x014aU, 0x0154U, 0x015eU, 0x0168U, 0x0172U, 0x017cU, 0x0186U, 0x0190U, 0x019aU,
    0x01a4U, 0x01aeU, 0x01b8U, 0x01c2U, 0x01ccU, 0x01d6U, 0x01e0U, 0x01eaU, 0x01f4U, 0x01feU,
    0x0208U, 0x0212U, 0x021cU, 0x0226U, 0x0230U, 0x023aU, 0x0244U, 0x024eU, 0x0258U, 0x0262U,
    0x026cU, 0x0276U, 0x0280U, 0x028aU, 0x0294U, 0x029eU, 0x02a8U, 0x02b2U, 0x02bcU, 0x02c6U,
    0x02d0U, 0x02daU, 0x02e4U, 0x02eeU, 0x02f8U, 0x0302U, 0x030cU, 0x0316U, 0x0320U, 0x032aU,
    0x0334U, 0x033eU, 0x0348U, 0x0352U, 0x035cU, 0x0366U, 0x0370U, 0x037aU, 0x0384U, 0x038eU,
    0x0398U, 0x03a2U, 0x03acU, 0x03b6U, 0x03c0U, 0x03caU, 0x03d4U, 0x03deU, 0x03e8U, 0x03f2U,
    0x03fcU, 0x0406U, 0x0410U, 0x041aU, 0x0424U, 0x042eU, 0x0438U, 0x0442U, 0x044cU, 0x0456U,
    0x0460U, 0x046aU, 0x0474U, 0x047eU, 0x0488U, 0x0492U, 0x049cU, 0x04a6U, 0x04b0U, 0x04baU,
    0x04c4U, 0x04ceU, 0x04d8U, 0x04e2U, 0x04ecU, 0x04f6U, 0x0500U, 0x050aU, 0x0514U, 0x051eU,
    0x0528U, 0x0532U, 0x053cU, 0x0546U, 0x0550U, 0x055aU, 0x0564U, 0x056eU, 0x0578U, 0x0582U,
    0x058cU, 0x0596U, 0x05a0U, 0x05aaU, 0x05b4U, 0x05beU, 0x05c8U, 0x05d2U, 0x05dcU, 0x05e6U,
    0x05f0U, 0x05faU, 0x0604U, 0x060eU, 0x0618U, 0x0622U, 0x062cU, 0x0636U, 0x0640U, 0x064aU,
    0x0654U, 0x065eU, 0x0668U, 0x0672U, 0x067cU, 0x0686U, 0x0690U, 0x069aU, 0x06a4U, 0x06aeU,
    0x06b8U, 0x06c2U, 0x06ccU, 0x06d6U, 0x06e0U, 0x06eaU, 0x06f4U, 0x06feU, 0x0708U, 0x0712U,
    0x071cU, 0x0726U, 0x0730U, 0x073aU, 0x0744U, 0x074eU, 0x0758U, 0x0762U, 0x076cU, 0x0776U,
    0x0780U
};

_Bool tps55289_enable_output()
{
    uint16_t trans[2];
    trans[0] = MODE_REG;
    trans[1] = (1 << OE_BIT) | (1 << HICCUP_BIT) | I2C_STOP;
    if(i2c0_do_transaction(I2C_ADDR, 2, trans))
        return true;
    else
        return false;
}

_Bool tps55289_disable_output()
{
    uint16_t trans[2];
    trans[0] = MODE_REG;
    trans[1] = (1 << DSCHG_BIT) | (1 << HICCUP_BIT) | I2C_STOP;
    if(i2c0_do_transaction(I2C_ADDR, 2, trans))
        return true;
    else
        return false;
}

_Bool tps55289_set_vout(uint16_t vout_set_mv)
{
    
    print_string("ref_value: ");
    print_hex(4, ref_value);
    print_string("\n\r");

    uint16_t trans[3];
    trans[0] = REF_LSB_REG;
    trans[1] = ref_value & 0x00ff;
    trans[2] = ref_value & 0x0700 | I2C_STOP;
    if(i2c0_do_transaction(I2C_ADDR, 3, trans))
        return true;
    else 
        return false;
}